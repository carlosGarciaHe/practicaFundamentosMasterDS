---
title: "Untitled"
author: "Alberto Corrales"
date: "30/11/2020"
output: html_document
---


```{r, results='hide'}
library(readr)
library(dplyr)
library(ggplot2)
library(gmodels)
library(Hmisc)

library(moments)
library(gridExtra)
library(vcdExtra)
library(Hmisc)
library(nortest)
library(car)
library(MASS)
library(forecast)
```

```{r}
set.seed(42)
```


```{r}
data = read_csv("BankCustomerdata.csv")
```

```{r}
n = nrow(data)
trainIndex = sample(1:n, size = round(0.8*n), replace=FALSE)
train = data[trainIndex ,]
test = data[-trainIndex ,]
```


### Variable AGE

Variable AGE muestra la edad del cliente con el que se contactó.

```{r}
describe(train$age)
```

Debes ser mayor de edad para contratar el depósito.
La media de edad de nuestros individuos se encuentra en torno a los 41 años.

```{r}
ggplot(train, aes(x = age)) +
  geom_histogram(aes(y = ..density..), fill="skyblue2", colour="white") +
  ggtitle('Edad del cliente')

ggplot(train,aes(x=age, fill = term_deposit)) + geom_histogram(aes(y = ..density..)) + geom_density(alpha = 0) + facet_wrap(~term_deposit) + ggtitle("Edad del cliente")

ggplot(train ,aes(x=age, fill=term_deposit)) + geom_density(alpha = .5) + ggtitle("Edad del cliente")
```
 
Podemos observar como son los jóvenes y los mayores los que mayor probabilidad de contratar el depósito tienen.

Se realiza un logit con la variable edad en forma continua para ver sus resultados.

```{r}
logit_edad = glm(as.factor(term_deposit) ~ age, family=(binomial(link=logit)), data = train)
summary(logit_edad)
```
Se comprueba como la variable edad en forma continua no es tan significativa ya que el peso de los ancianos se contrarresta con el peso de los jóvenes. Por ello aumentar la variable edad en una unidad no tiene un efecto tan significativo en nuestra variable objetivo.

Tendríamos que sacar el efecto marginal para ver cuanto aumenta realmente la probabilidad de contratar el depósito. Aunque se puede ver que tiene efecto positivo y es significativa al 10% dicha variable.

```{r}
logitvec_edad = mean(dlogis(predict(logit_edad, type = "link")))

logitvec_edad * coef(logit_edad)
```

La probabilidad de contratar el depósito aumenta un 0.0003 cada vez que se incrementa la edad en un año.

Se puede apreciar como los más jóvenes y los más mayores tienen mayor probabilidad de contratar el depósito. Queremos ver si estas particularidades tienen efecto que con en una variable continua se podrían obviar.

Para ello convertimos nuestra variable continua en una variable categórica.

```{r}
train = train %>% mutate(age_categorica = cut(age, breaks = c(0, 29, 44, 59, 100), right = TRUE, labels = c('Joven','MedianaEdad','Mayores','Ancianos')))
```

```{r}
ftable(train$age_categorica)
describe(train$age_categorica)
```

```{r}
train$age_categorica = factor(train$age_categorica, levels=(c('MedianaEdad', 'Joven','Mayores','Ancianos')))
```


```{r}
levels(train$age_categorica)
```

```{r}
with(train, CrossTable(age_categorica, term_deposit, format = 'SPSS'))
```

```{r}
ggplot(train, aes(x = age_categorica, fill = term_deposit)) + geom_bar(position= position_fill(reverse = TRUE)) + coord_flip() + labs(x = 'Edad del cliente', y = 'prop') + ggtitle("Edad del cliente")
```


Se puede comprobar como las personas de mayor edad y los más jóvenes son los más propensos a contratar el depósito que las personas de mediana edad y que las personas mayores.

Realizamos un logit con esta variable categórica donde la categoría de referencia se encuentra en mediana edad. Aquellas personas entre 30 y 44 años.

```{r}
logit_edadcat = glm(as.factor(term_deposit) ~ age_categorica, family=(binomial(link=logit)), data = train)
summary(logit_edadcat)
```
 
Tendríamos que sacar el efecto marginal para ver cuanto aumenta la probabilidad de contratar el depósito respecto a las personas de mediana edad para los jóvenes y para los ancianos. Son estos los que con la evidencia que tenemos son más probables de contratar un depósito.

```{r}
 logitvec_edadcat = mean(dlogis(predict(logit_edadcat, type = "link")))
 logitvec_edadcat * coef(logit_edadcat)
```


Únicamente tendríamos que tener cuidado con la variable Ancianos ya que podría estar mayormente correlada con la profesión del cliente. En concreto con los jubilados(Retired)


### Variable BALANCE

Variable que indica el saldo del cliente.

```{r}
describe(train$balance)
```

Variable tiene saldo negativo lo que podría limitar su transformación aunque existe otra variable en el modelo donde se indica si el cliente está o no en mora.

La distribución de la variable cuenta con una larga cola que hace complicado estudiar la distribución más allá de los valores iniciales. 

```{r}

ggplot(train, aes(x = balance)) +
  geom_histogram(fill="skyblue2", colour="white") + ggtitle('Saldo del cliente')

ggplot(train, aes(x=balance, fill = term_deposit)) + geom_histogram(aes(y = ..density..)) + geom_density(alpha = .5) + facet_wrap(~term_deposit) + ggtitle("Saldo del cliente")

ggplot(train ,aes(x=balance, fill=term_deposit)) + geom_density(alpha = .3) + ggtitle("Saldo del cliente")

```


Se comprueba como no se puede apreciar correctamente las funciones de densidad condicionadas a contratar o no el depósito. Por ello, debemos pensar en transformar nuestra variable.

Primero comprobamos como tener saldo negativo es distinto de estar en mora al menos con los datos que tenemos. Por ello, tendríamos que ir con más cuidado a la hora de realizar una transformación logaritmica de nuestra variable.

```{r}
balance_neg = train %>% filter(balance < 0)
describe(balance_neg$balance)
describe(balance_neg$default)
```

Las personas que tienen saldo negativo en nuestro data set son 2964 clientes.
Aunque los clientes que tienen un crédito en mora tan solo son 354. Representa tan solo el 12% del total con saldo negativo.

```{r}
balance_cero = train %>% filter(balance == 0)
describe(balance_cero$balance)
describe(balance_cero$default)
```
 
Se comprueba como aquellos que tienen saldo 0 son 2716 clientes sumándoles aquellos con saldo negativo suponen 5680 observaciones mientras que las personas con mora pertenecientes a esos grupo únicamente suman 448 observaciones.

Por tanto, la variable default no podría explicar aquellas observaciones perdidas al realizar el logaritmo.
```{r}
balance_pos = train %>% filter(balance > 0)
describe(balance_pos$balance)

train = train %>% mutate(log_balance = log10(balance))

describe(train$log_balance)
```

Se transforma la variable mediante el logaritmo para suavizar el crecimiento al principio y acrecentarlo al final.

Al realizar esta transformación se producen valores NaNs. En la variable balance existen 5680 valores en los cuales el cliente no tiene saldo o su saldo es negativo. 

```{r}
ggplot(train, aes(x = log_balance)) +
  geom_histogram(fill="skyblue2", colour="white") + ggtitle('Log saldo del cliente')

ggplot(train, aes(x=log_balance, fill = term_deposit)) + geom_histogram(aes(y = ..density..)) + geom_density(alpha = .5) + facet_wrap(~term_deposit) + ggtitle("Log saldo del cliente")

ggplot(train ,aes(log_balance, fill=term_deposit)) + geom_density(alpha = .5) + ggtitle("Log saldo del cliente")
```

Con esta visualización únicamente podemos intuir que aquellas personas con mayor saldo en cuenta tienen mayor probabilidad de contratar un depósito.

Por ello, otra opción que se podría realizar en vez de realizar el logaritmo y perder información se podría categorizar la variable respecto al saldo en cuenta.

```{r}
bal = train %>% filter(balance > 0)
describe(bal$balance)
sd(bal$balance)
IQR(bal$balance)
```

Se dividiría la variable en cuatro categorías.

Saldos negativos. Siendo la cantidad inferior a 0.

Saldos bajos. De acuerdo a nuestros datos, la media de saldos positivos se encuentra en torno a 1500 euros. Aunque está sesgada debido a la gran cantidad de saldos altos y a una gran dispersión en nuestros datos. Por ello, se aumenta el límite de esta franja hasta los 2000€. La mediana de los datos se encuentra en torno a 635 y el IQR en torno a 1500. 

Saldos medios. Se encuentra cercanos desde la media hasta los 10000 euros. 

Saldos altos. A partir de dicha cantidad teniendo en cuenta la distribución de nuestros datos.


```{r}
train = train %>% mutate(balance_categorica = cut(balance, breaks = c(-10000, 0, 2000, 10000, 105000), right = FALSE, labels = c('Negativo','Bajo','Medio', 'Alto')))
```

```{r}
ftable(train$balance_categorica)
describe(train$balance_categorica)
```

```{r}
with(train, CrossTable(balance_categorica, term_deposit, format = 'SPSS'))
```

Al establecer las categorías en base a nuestros datos de entrenamiento se podría caer también en overfitting.

```{r}
ggplot(train, aes(x = balance_categorica, fill = term_deposit)) + geom_bar(position= position_fill(reverse = TRUE)) + coord_flip() + labs(x = 'Saldo en cuenta cliente', y = 'prop') + ggtitle("Saldos del cliente")
```

Se aprecia como a medida que crecen los saldos, la probabilidad de contratar un depósito aumenta.


### Variable DAYS

Variable días muestra en qué día del mes se contacto con el cliente.

```{r}
describe(train$day)
```

```{r}
ggplot(train, aes(x = day)) +
  geom_histogram(aes(y = ..density..), fill="skyblue2", colour="white") +
  ggtitle('Día del mes')

ggplot(train,aes(x=day, fill = term_deposit)) + geom_histogram(aes(y = ..density..)) + geom_density(alpha = 0) + facet_wrap(~term_deposit) + ggtitle("Día del mes")

ggplot(train ,aes(x=day, fill=term_deposit)) + geom_density(alpha = .3) + ggtitle("Día del mes")

```
 
No se aprecia un patrón claro, salvo distintos picos que nos permite dividir la variable en tres partes. 

La variable de forma continua no tiene interpretación clara. Por este motivo, se transforma la variable para ver si se encuentra alguna característica relevante en ella.

```{r}
train = train %>% mutate(day_categorica = cut(day, breaks = c(0, 10, 20, 31), labels = c('InicioMes','MedioMes','FinalMes')))
```

```{r}
ftable(train$day_categorica)
describe(train$day_categorica)
```

```{r}
with(train, CrossTable(day_categorica, term_deposit, format = 'SPSS'))
```

```{r}
ggplot(train, aes(x = day_categorica, fill = term_deposit)) + geom_bar(position= position_fill(reverse = TRUE)) + coord_flip() + labs(x = 'Día de contacto', y = 'prop') + ggtitle("Día de contacto")
```
 
Como podemos observar no existe un patrón claro a la hora de encontrar diferencias significativas en la probabilidad de contratar un depósito dependiendo del día del mes en el que se contactó con el cliente.

Únicamente existe una mayor probabilidad a la hora de contratar un depósito a principio de mes, pero sin diferencias significativas.


### Variable DURATION
Es una variable cuantitativa que muestra la duración en segundos del último contacto mantenido con el cliente. 
```{r}
describe(train$duration)
```

Variable complicada ya que puede estar muy correlacionada con la variable dependiente.

```{r}
ggplot(train, aes(x = duration)) +
  geom_histogram(fill="skyblue2", colour="white") + ggtitle('Duracion contacto con el cliente')

ggplot(train, aes(x=duration, fill = term_deposit)) + geom_histogram(aes(y = ..density..)) + geom_density(alpha = .5) + facet_wrap(~term_deposit) + ggtitle("Duracion contacto con el cliente")

ggplot(train ,aes(x=duration, fill=term_deposit)) + geom_density(alpha = .3) + ggtitle("Duracion contacto con el cliente")
```

Se comprueba como el estar mayor tiempo de contacto con el cliente afecta positivamente a la probabilidad de contratar el depósito.

Se estudia las posibles transformaciones de la variable duration.

```{r}
symbox(~duration, data = train)

duration_pos = train %>% filter(duration > 0)
BoxCox.lambda(duration_pos$duration, method = 'loglik', lower = -5, upper = 5)
boxcox(duration_pos$duration ~1)
```

 
La transformación más aproximada es el logaritmo. Se mira cuantos valores existen a los que no se le puede aplicar y deberían ser eliminados.

Se transforma la variable mediante el logaritmo para suavizar el crecimiento al principio y acrecentarlo al final.

```{r}
duration_cero = train %>% filter(duration == 0)
describe(duration_cero$duration)


train = train %>% mutate(log_duration = log10(duration))

describe(train$log_duration)

```

Al aplicar logaritmo existen tres valores iguales a 0 que se deberían eliminar.

```{r}
ggplot(train, aes(x = log_duration)) +
  geom_histogram(fill="skyblue2", colour="white") + ggtitle('Log duracion contacto con el cliente')

ggplot(train, aes(x=log_duration, fill = term_deposit)) + geom_histogram(aes(y = ..density..)) + geom_density(alpha = .5) + facet_wrap(~term_deposit) + ggtitle("Log duracion contacto con el cliente")

ggplot(train ,aes(log_duration, fill=term_deposit)) + geom_density(alpha = .5) + ggtitle("Log duracion contacto con el cliente")

```

Se aprecia como aquellas personas con mayor duración del contacto son las que tienen mayor probabilidad de contratar el depósito. Aunque es una variable muy correlacionada con la variable objetivo.


### Variable CAMPAIGN
Número de veces que se ha contactado con un cliente en la campaña actual

```{r}
describe(train$campaign)
```

Se aprecia como la mediana, es decir el 50% de la población recibió dos contactos o menos. Así como solo un 10% de la población recibió más de 5 contactos.

```{r}
ggplot(train, aes(x = campaign)) +
  geom_histogram(aes(y = ..density..), fill="skyblue2", colour="white") +
  ggtitle('Nº de contactos con el cliente actual campaña')

ggplot(train,aes(x=campaign, fill = term_deposit)) + geom_histogram() + facet_wrap(~term_deposit) + ggtitle("Nº de contactos con el cliente actual campaña")

ggplot(train,aes(x=campaign, fill = term_deposit)) + geom_histogram(aes(y = ..density..)) + facet_wrap(~term_deposit) + ggtitle("Nº de contactos con el cliente actual campaña")

```


Se aprecia como aquellas personas con la que menos se ha contactado son las que más probabilidades tienen de contratar un depósito.

```{r}
with(train, CrossTable(campaign, term_deposit, format = 'SPSS'))

```

Se realiza una tabla cruzada con la variable objetivo para ver ver más detalladamente la composición de la variable. 

```{r}
ggplot(train, aes(x = campaign, fill = term_deposit)) + geom_bar(position= position_fill(reverse = TRUE)) + coord_flip() + labs(x = 'Nº de contactos con el cliente', y = 'prop') + ggtitle("Nº de contactos con el cliente")
```


Se comprueba como contactar solo una vez con el cliente tiene mayor probabilidad de contratar el depósito y esta va decreciendo conforme aumenta en una unidad el número de contactos con el cliente. 

Posibles transformaciones. 
Yo dejaría la variable tal y como está dado que un aumento en el número de contactos reduce la probabilidad de contratar el depósito. Aunque tendría en cuenta los outliers y los trataría.

Se realiza un logit con la variable objetivo para ver sus resultados.

```{r}
logit = glm(as.factor(term_deposit) ~ campaign, family=(binomial(link=logit)), data = train)
summary(logit)
```
 
Tendríamos que sacar el efecto marginal para ver cuanto se reduce realmente la probabilidad de contratar el depósito. Aunque se puede ver que tiene efecto negativo y es significativa dicha variable

```{r}
 logitvec = mean(dlogis(predict(logit, type = "link")))
 logitvec * coef(logit)
```

El efecto provoca que un aumento del contacto con el cliente en una unidad provoca que la probabilidad de contratar el depósito se reduzca en 0.0093.

Otras opciones sería realizar una variable categórica binaria a tal efecto. 
Dividiéndose en haber tenido un contacto o más de un contacto lo cual reduce la probabilidad de contratar un depósito.

```{r}
train = train %>% mutate(campaign_binaria = cut(campaign, breaks =  c(1, 2, 300), right = FALSE, include.lowest = TRUE, labels = c('1Contacto', '+1Contacto')))
```


```{r}
ftable(train$campaign_binaria)
```

```{r}
describe(train$campaign_binaria)
with(train, CrossTable(campaign_binaria, term_deposit, format = 'SPSS'))
```


```{r}
ggplot(train, aes(x = campaign_binaria, fill = term_deposit)) + geom_bar(position= position_fill(reverse = TRUE)) + coord_flip() + labs(x = 'Nº de contactos con el cliente', y = 'prop') + ggtitle("Nº de contactos con el cliente")
```

Se aprecia como tener un solo contacto con el cliente aumenta su probabilidad de contratar al depósito al contrario ocurre cuando contactas con el cliente más de una vez.

```{r}
train$campaign_binaria = factor(train$campaign_binaria, levels=(c('+1Contacto', '1Contacto')))
```

```{r}
levels(train$campaign_binaria)
```
 
Estamos metiendo como variable de referencia a la variable que cuenta con mayor número de observaciones.

```{r}
logit_uno = glm(as.factor(term_deposit) ~ campaign_binaria, family=(binomial(link=logit)), data = train)
summary(logit_uno)
```

```{r}
 logitvec_uno <- mean(dlogis(predict(logit_uno, type = "link")))
 logitvec_uno * coef(logit_uno)
```

Tener solo un contacto aumenta la probabilidad de contratar el depósito alrededor del 3.3% respecto a tener más de un contacto.

También se puede dividir la variable en 6 categorias ya que el 90% de los clientes han tenido menos de 5 contactos.

```{r}
train = train %>% mutate(campaign_categorica = cut(campaign, breaks =  c(1, 2, 3, 4, 5, 6, 300), right = FALSE, include.lowest = TRUE, labels = c(' 1 Contacto', ' 2 Contactos', '3 Contactos', '4 Contactos', '5 Contactos', '+ 5 Contactos')))
```

```{r}
ftable(train$campaign_categorica)
```

```{r}
describe(train$campaign_categorica)
with(train, CrossTable(campaign_categorica, term_deposit, format = 'SPSS'))
```

```{r}
ggplot(train, aes(x = campaign_categorica, fill = term_deposit)) + geom_bar(position= position_fill(reverse = TRUE)) + coord_flip() + labs(x = 'Nº de contactos con el cliente', y = 'prop') + ggtitle("Nº de contactos con el cliente")
```

Se comprueba como a medida que se elevan los contactos la probabilidad de contratar un depósito se va reduciendo. 

```{r}
logit_dos = glm(as.factor(term_deposit) ~ campaign_categorica, family=(binomial(link=logit)), data = train)
summary(logit_dos)
```


```{r}
 logitvec_dos = mean(dlogis(predict(logit_dos, type = "link")))
 logitvec_dos * coef(logit_dos)
```

Podemos comprobar como a medida que van aumentando los contactos se va reduciendo en mayor medida la probabilidad de contratar un depósito respecto a tener un único contacto.

Sería interesante tratar esta variable como una variable discreta en la cual el aumento de contactos con el cliente redujese la probabilidad de contratar el depósito. Si penaliza este aumento creciente en los contactos aunque se traduce en menor efecto para pocos contactos que cuando tratamos con variables categóricas o binarias

### Variable PDAYS
 
Muestra los días que han pasado desde que se contactó con el cliente en la campaña anterior.

```{r}
describe(train$pdays)
```

Existen clientes con los que no se ha contactado en la campaña anterior.
En su gran mayoría no se ha contactado anteriormente con este cliente indicándose en la base de datos con valor -1.

```{r}
ggplot(train, aes(x = pdays)) +
  geom_histogram(fill="skyblue2", colour="white") +
  ggtitle('Número dias desde último contacto en campañas anteriores')

ggplot(train,aes(x=pdays, fill=term_deposit)) + geom_histogram() + facet_wrap(~term_deposit, nrow = 1) + ggtitle("Número días desde último contacto en campañas anteriores")

ggplot(train,aes(x=pdays, fill=term_deposit)) + geom_histogram(aes(y = ..density..)) + facet_wrap(~term_deposit, nrow = 1) + ggtitle("Número días desde último contacto en campañas anteriores")
```
 
No se pueden apreciar ninguna característica adiccional en esta variable dado el gran peso que tiene no haber contactado anteriormente con el cliente en nuestra base de datos.

Para poder encontrar algún patrón que influya en la variable objetivo debemos mirar con mayor precisión. Por ello, evaluamos el 25% de los datos restantes para poder extraer una conclusión en base al número de días que pasaron desde que se contactó en la anterior campaña.

```{r}
pdays_pos = train %>% filter(pdays != -1)
describe(pdays_pos$pdays)

ggplot(pdays_pos, aes(x = pdays, colour = term_deposit)) +
  geom_histogram() + facet_wrap(~term_deposit, ncol = 2) +
  ggtitle('Número días desde último contacto en campañas anteriores')

ggplot(pdays_pos,aes(x=pdays, fill = term_deposit)) + geom_histogram(aes(y = ..density..)) + geom_density(alpha = 0) + facet_wrap(~term_deposit) + ggtitle("Número días desde último contacto en campañas anteriores")

ggplot(pdays_pos ,aes(x=pdays, fill=term_deposit)) + geom_density(alpha = .5) + ggtitle("Número días desde último contacto en campañas anteriores")
```
 
Se puede apreciar como con aquellas personas que se contacta antes de los  primeros 210 días (7 meses) existe una mayor proporción a la hora de contratar el depósito que respecto a las personas con las que se tarda en contactar mas tiempo respecto de la campaña anterior.

La mediana se encuentra en 224 días. Por ello, realizamos el corte dada la distribución y visualización de datos en una medida fácil de entender como son 7 meses = 210 días.

Para poder ver si esta variable es útil para nuestro objetivo, procedemos a crear una nueva variable categórica.

```{r}
train = train %>% mutate(pdays_categorica = cut(pdays, breaks =  c(-1, 0, 210, 536), right = FALSE, include.lowest = TRUE, labels = c('No contacto', '<7 Meses', '>7 Meses')))
```

```{r}
ftable(train$pdays_categorica)
```

```{r}
describe(train$pdays_categorica)
with(train, CrossTable(pdays_categorica, term_deposit, format = 'SPSS'))
```


```{r}
ggplot(train, aes(x = pdays_categorica, fill = term_deposit)) + geom_bar(position= position_fill(reverse = TRUE)) + coord_flip() + labs(x = 'Contacto desde anterior campaña', y = 'prop') + ggtitle("Tiempo de contacto desde la anterior campaña")
```
 
El gráfico muestra como aquellos con los que se volvió a contactar en menos de 7 meses desde la campaña anterior tienen mayor probabilidad de contratar el depósito que con los que se contactó después de esos 7 meses o incluso no se había contactado anteriormente.


### Variable Previous

Variable cuantitativa que muestra el número de contactos que se realizaron al cliente en campañas anteriores.

```{r}
describe(train$previous)
```

Se aprecia como el 75% de los clientes no había sido contactado anteriormente al igual que en la variable pdays. 

También notar que un 15% de los clientes únicamente había sido contactado 1 vez y sólo un 5% más de 3 veces.

```{r}
ggplot(train, aes(x = previous)) +
  geom_histogram(fill="skyblue2", colour="white") +
  ggtitle('Número de contactos en campañas anteriores')

ggplot(train,aes(x=previous, fill=term_deposit)) + geom_histogram() + facet_wrap(~term_deposit, nrow = 1) + ggtitle("Número de contactos en campañas anteriores")

ggplot(train,aes(x=previous, fill=term_deposit)) + geom_histogram(aes(y = ..density..)) + facet_wrap(~term_deposit, nrow = 1) + ggtitle("Número de contactos en campañas anteriores")
```
 
 
No se puede apreciar ninguna característica adiccional en esta variable dado el gran peso que tiene no haber tenido ningún contacto anteriormente con el cliente en campañas anteriores en la base de datos.

Para poder encontrar algún patrón que influya en la variable objetivo debemos mirar con mayor precisión. Se evalua el 25% de los datos restantes para poder extraer una conclusión en base al número de veces que se contactó con el cliente en campañas anteriores.

```{r}
previous_pos = train %>% filter(previous >0)
describe(previous_pos$previous)

ggplot(previous_pos, aes(x = previous, colour = term_deposit)) +
  geom_histogram() + facet_wrap(~term_deposit, ncol = 2) +
  ggtitle('Número de contactos en campañas anteriores')

ggplot(previous_pos,aes(x=previous, fill = term_deposit)) + geom_histogram(aes(y = ..density..), bins = 50) + facet_wrap(~term_deposit) + ggtitle("Número de contactos en campañas anteriores")

```
 
Para toda la muestra obviando aquellos a los que no se contactó. El 95% tuvo menos de 8 contactos.

También se comprueba como a medida que va creciendo el número de contactos la probabilidad de contratar un depósito se reduce siendo ínfima cuando se supera el número de 10 contactos.

Analizando más al detalle obviando outliers. Se puede ver la composición de la variable

```{r}
previous_pos = train %>% filter(previous >0 & previous <= 30)
describe(previous_pos$previous)

ggplot(previous_pos, aes(x = previous, colour = term_deposit)) +
  geom_histogram() + facet_wrap(~term_deposit, ncol = 2) +
  ggtitle('Número de contactos en campañas anteriores')

ggplot(previous_pos,aes(x=previous, fill = term_deposit)) + geom_histogram(aes(y = ..density..), bins = 50) + facet_wrap(~term_deposit) + ggtitle("Número de contactos en campañas anteriores")

```

Por último, realizamos una tabla cruzada para ver más detalladamente la composición de la variable.

```{r}
with(train, CrossTable(previous, term_deposit, format = 'SPSS'))
```

Una vez analizada mediante esta tabla lo más razonable sería realizar una transformación de la variable cuantitativa en una variable binaria dependiendo de si se ha contactado anteriormente o no con el cliente.

En torno al 85% de los clientes no habían sido contactados previamente.

```{r}
train = train %>% mutate(previous_categorica = cut(previous, breaks =  c(0, 1, 300), right = FALSE, include.lowest = TRUE, labels = c('Sin Contacto previo', 'Contacto previo')))
```

```{r}
ftable(train$previous_categorica)
```

```{r}
describe(train$previous_categorica)
with(train, CrossTable(previous_categorica, term_deposit, format = 'SPSS'))
```
```{r}
ggplot(train, aes(x = previous_categorica, fill = term_deposit)) + geom_bar(position= position_fill(reverse = TRUE)) + coord_flip() + labs(x = 'Contacto en campaña anterior', y = 'prop') + ggtitle("Contacto en la anterior campaña")
```
 
El gráfico muestra como aquellos con los que se contactó previamente tienen mayor probabilidad de contratar un depósito que aquellos con los que no se había contactado en la campaña anterior.

Variable muy relacionada con pdays ya que determina el número de días que pasó desde que se contactó con el cliente en la campaña mientras que pdays determina el número de días que pasaron desde que se contactó en campañas anteriores con el cliente.

Si se introduce una de las dos variables no se debe introducir la otra por problemas de multicolinealidad.
